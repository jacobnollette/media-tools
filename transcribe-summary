#!/bin/bash

# Define the root directory to search recursively (current directory by default)
input_dir="${1:-.}"

_process () {
  item="$@"

  # Remove extension from filename if present
  _inputFileNoEXT=$(basename -- "$item" | sed 's/\.vtt//')

  # Check for existence of summary.md and create it if necessary
  if [[ ! -f "${_inputFileNoEXT}-summary.md" ]]; then
    touch "${_inputFileNoEXT}-summary.md"
  fi

  # Read the HTML content of the file using a temporary directory to avoid path issues
  echo "Below I am going to provide a video transcript; please provide no less than 400 words of summary analysis of the video per 10 minutes
" > "/tmp/prompt-press"
  cat "$item" >> "/tmp/prompt-press"

  # Use Ollama to convert the HTML content to Markdown and save to .md file
  cat "/tmp/prompt-press" | ollama run llama3.2:latest > "${_inputFileNoEXT}-summary.md"

  echo "clean up this summary; provide expanded descriptive call outs for any intellectual or informative threads from this summary.
" > /tmp/prompt-press
  cat "${_inputFileNoEXT}-summary.md" > /tmp/prompt-press
  cat "/tmp/prompt-press" | ollama run llama3.2:latest > "${_inputFileNoEXT}-summary.md"

  # Clean up temporary directory
  rm -rf "$tmp_dir"
  
  # Signal complete message
  echo "Summarized $item to ${_inputFileNoEXT}-summary.md"
}

# Find all .vtt files in the specified input directory and its subdirectories
for i in *.vtt; do
  _process "$i"
done
